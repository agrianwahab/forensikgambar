{% extends 'base.html' %}

{% block content %}
<!--
ASCII Mockup for Analysis Progress Page:
... (mockup comments remain the same) ...
-->
<div class="analysis-page terminal-container" data-analysis-id="{{ analysis.id }}">
    <div class="analysis-header terminal-header">
        <h2 class="terminal-title">Proses Analisis Gambar: {{ analysis.original_filename }}</h2>
        <!-- Tombol batal bisa ditambahkan jika ada fungsionalitasnya -->
        <!-- <button class="btn btn-danger btn-sm" id="cancelAnalysisBtn">[Batalkan]</button> -->
    </div>

    <div class="analysis-content">
        <div class="progress-overview">
            <p>Status: <strong id="analysisStatus" class="status-{{ analysis.status }}">{{ analysis.status|capitalize }}</strong></p>
            <div class="progress-bar-container">
                <div class="progress-bar">
                    {# More robust Jinja expression, though original should be fine #}
                    <div class="progress-fill" id="progressFill" style="width: {{ analysis.progress|default(0)|float }}%;"></div>
                </div>
                <span class="progress-text" id="progressText">{{ "%.1f"|format(analysis.progress) }}%</span>
            </div>
            <p>Tahap: <span id="currentStageNumber">{{ analysis.current_stage_num }}</span>/<span id="totalStageNumber">{{ analysis.total_stages_num }}</span> - <strong id="currentStageName">{{ analysis.current_stage_name }}</strong></p>
            <p id="estimatedTime">Estimasi Waktu Sisa: <span id="etaValue">menghitung...</span></p>
        </div>

        <div class="stages-details">
            <h3 class="stages-title">Detail Tahapan Analisis:</h3>
            <ul class="stages-list" id="stagesList">
                {% for stage in ui_stages %}
                <li class="stage-item status-{{ stage.status }}" id="stage-{{ stage.id }}">
                    <span class="stage-icon">
                        {% if stage.status == 'completed' %}✓
                        {% elif stage.status == 'active' %}⟳
                        {% elif stage.status == 'error' %}⚠
                        {% else %}○
                        {% endif %}
                    </span>
                    <span class="stage-name">[{{ stage.id }}/{{ analysis.total_stages_num }}] {{ stage.name }}</span>
                    <span class="stage-status-label">{{ stage.status|capitalize }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <div id="analysisErrorDetails" class="analysis-error-details" style="display:none;">
            <h4>Detail Kesalahan:</h4>
            <p id="errorMessageText"></p>
        </div>

        <div class="analysis-footer">
            <p>Harap tunggu hingga proses analisis selesai. Halaman akan otomatis diarahkan ke hasil analisis.</p>
            <a href="{{ url_for('main.history') }}" class="btn btn-secondary btn-sm">Kembali ke Riwayat</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/analysis.js') }}"></script>
{% endblock %}